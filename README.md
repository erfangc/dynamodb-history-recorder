# Terraform Module dynamodb-history-recorder

This Terraform Module takes an existing DynamoDB table (with DynamoDB Stream enabled) and write all
changes to items on the table to another table (aka the `history` table) via a Lambda

The hash and range keys of the original table are concatenated to form `originalItemID` which is the hash key of
the `history` table

## How to Use

Create a DynamoDB table

```hcl
resource "aws_dynamodb_table" "requests" {
  name         = "requests"
  billing_mode = "PAY_PER_REQUEST"

  attribute {
    name = "Id"
    type = "S"
  }
  
  # DynamoDB Stream must be enabled, and view type must contains old and new images
  stream_enabled   = true
  stream_view_type = "NEW_AND_OLD_IMAGES"
  hash_key         = "Id"
}
```

Instantiate this Module

```hcl
module "requests-history-recorder" {
  source = "../"

  subnet_ids          = data.aws_subnet_ids.subnet_ids.ids
  vpc_id              = data.aws_vpc.default_vpc.id
  dynamodb_table_name = aws_dynamodb_table.requests.name

  # need this if the DynamoDB table being recorded does not already exist
  depends_on = [aws_dynamodb_table.requests]
}
```

## Argument Reference

`subnet_ids` - (Required) the subnets that the underlying Lambda function is allowed to run in. 
You must ensure these subnets can reach DynamoDB either through a VPCE or IGW

`vpc_id` - (Required) the VPC that the underlying Lambda function will run in

`dynamodb_table_name` - (Required) The DynamoDB table whose history to monitor and record into a `_history` table

`dynamodb_user_id_attribute_name` - (Optional) The attribute in your DynamoDB that denote the user who made the change. This 
can either be a "S" or "N" attribute. This attribute will populate the `userID` attribute in the resulting history table

`history_table_billing_mode` - (Optional) The billing_mode of the history table

`history_table_read_capacity` - (Optional) The read_capacity of the history table

`history_table_write_capacity` - (Optional) The write_capacity of the history table

`history_table_tags` - (Optional) The tags of the history table


## Attributes Reference

`history_table_name` - Name of the history table that will contain all the events


`lambda_function_name` - Name of the Lambda function that listens to the original DynamoDB table and copies the results to the history table


`lambda_security_group_id` - The ID of the security group generated by this module and assigned to the Lambda 


`lambda_security_group_name` - The Name of the security group generated by this module and assigned to the Lambda 


`cloudwatch_log_group_name` - The ID of the CloudWatch log group generated by this module and assigned to the Lambda 

